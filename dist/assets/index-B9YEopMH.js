(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function a(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(n){if(n.ep)return;n.ep=!0;const o=a(n);fetch(n.href,o)}})();const c={Idle:"Idle",Searching:"Searching",Revealing:"Revealing",GameOver:"GameOver"};function h(e,t){const a=t.fsm;return{start:[c.Idle],search:[c.Idle,c.Revealing],reveal:[c.Searching],next:[c.Revealing],gameover:[c.Revealing]}[e]?.includes(a)}function M(e){const t=Math.max(...e.scores);return{winnerIndex:e.scores.findIndex(r=>r===t),winnerScore:t}}function y(e,t){e.nextPlayerButton.disabled=!0,e.searchButton.disabled=!0,e.revealButtons.forEach(a=>a.disabled=!0),x(e,t)}function x(e,t){const a=e.keywordInput.value.trim(),r=a.normalize("NFKC").toLowerCase(),n=e.resultList;if(t.recentHits.length===0&&a!==""){n.innerHTML=`<strong>HIT!</strong><ul><li>検索ワード「${a}」に一致する結果はありませんでした。</li></ul>`,n.classList.remove("hidden");return}if(t.recentHits.length===0&&a===""){n.innerHTML="<strong>HIT!</strong><ul><li>検索ワードを入力して検索してください。</li></ul>",n.classList.remove("hidden");return}const o=t.recentHits.slice(0,30).map(s=>{const l=s.name||"",i=s.maker||"",d=m=>m.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),f=m=>r?m.replace(new RegExp(d(r),"gi"),S=>`<span style="color:green;font-weight:bold;">${S}</span>`):m;return`<li>${f(l)}, ${f(i)}</li>`}).join("");n.innerHTML=`<strong>HIT!</strong><ul>${o}</ul>`,n.classList.remove("hidden")}function b(e,t){e.showResultsButton.addEventListener("click",()=>x(e,t))}function w(e,t){if(!e.filterChips)return;if(!t||!t.length){e.filterChips.innerHTML="",e.filterChips.classList.add("hidden");return}const a=t.map(r=>`<span class="chip ${r.variant||""}">${r.text}</span>`).join("");e.filterChips.innerHTML=a,e.filterChips.classList.remove("hidden")}function u(e,t,a="none",r=""){const n=[];if(t.restrict&&t.restrict!=="none"){const o=t.restrict==="year"?"導入年":t.restrict==="maker"?"メーカー":"機種名";let s="";t.restrict==="year"?s=e.yearSelect?.value||"":s=e.andValue?.value?.trim()||"";const l=`縛り: ${o}${s?o==="導入年"?`=${s}年`:`=${s}`:""}${t.exLocked?"（EXロック）":""}`;n.push({text:l,variant:"lock"})}if(a&&a!=="none"&&a!==t.restrict){const o=a==="year"?"導入年":a==="maker"?"メーカー":"機種名",s=`AND: ${o}${r?o==="導入年"?`=${r}年`:`=${r}`:""}`;n.push({text:s,variant:"and"})}w(e,n)}function k(e,t,a){const r=e.digits[t];r.classList.add("no-anim"),r.classList.add("covered"),r.classList.remove("opened"),r.dataset.value=a;const n=r.querySelector(".digit-value");n&&(n.textContent=a),requestAnimationFrame(()=>{requestAnimationFrame(()=>{r.classList.remove("no-anim")})})}function I(e){return e.digits.map(t=>t.classList.contains("opened")&&t.dataset.value||"?")}function P(e,t,a){e.searchButton.addEventListener("click",async()=>{const r=e.keywordInput.value.trim();if(!r&&e.restrictMode?.value==="none"){e.showMessage("検索ワードを入力してください");return}let n=e.andField?.value||"none";e.restrictMode?.value&&e.restrictMode.value!=="none"&&(n=e.restrictMode.value);let o="";if(n==="year"){const l=e.restrictMode?.value==="year"?e.yearSelect?.value||"":e.andYearSelect?.value||"";if(!l){e.showMessage("導入年を選択してください");return}o=l}else if((n==="name"||n==="maker")&&(o=e.andValue?.value.trim()||"",!o)){e.showMessage(n==="name"?"機種名を入力してください":"メーカー名を入力してください");return}if(/^[0-9０-９]+$/.test(r)&&r.length<=2){e.showMessage("リトライ！数字のみの場合は3文字以上で"),e.keywordInput.value="";return}e.searchButton.disabled=!0;try{const l=await a.search(r,{field:n,value:o});if(e.searchButton.disabled=!1,!l)return;const i=document.createElement("li"),d=n==="none"?"":n==="year"?` / AND: ${o}年`:n==="maker"?` / AND: メーカー=${o}`:` / AND: 機種名=${o}`;i.textContent=r?`${r}${d}`:d.replace(/^ \/\s*/,""),e.usedWords.appendChild(i),u(e,t,n,o),l.forEach((f,m)=>k(e,m,f)),e.resultList.classList.add("hidden"),e.showMessage("")}catch(l){console.error(l),e.searchButton.disabled=!1,e.showMessage("検索中にエラーが発生しました")}}),e.revealButtons.forEach(r=>r.addEventListener("click",()=>{const n=Number(r.dataset.digit)-1,o=e.digits[n];if(!o.dataset.value||o.classList.contains("opened"))return;o.classList.add("opened");const s=a.revealIfAllOpened();if(s){if(s.type==="perfect")e.resultMessage.classList.add("game-over"),e.showMessage(`完全勝利！P${t.currentPlayer}のスコアは${t.scores[t.currentPlayer-1]}点です！`),y(e,t);else if(s.type==="bust"){e.resultMessage.classList.add("game-over","over-score");const{winnerIndex:l,winnerScore:i}=M(t);e.showMessage(`パンク！ゲーム終了となりプレイヤー${l+1}が${i}点で勝利！`),y(e,t)}else if(s.type==="score"&&(s.exLockYear?(e.restrictMode.value="year",e.restrictMode.dispatchEvent(new Event("change")),e.restrictMode.disabled=!0,e.yearSelect&&(e.yearSelect.value=s.exLockYear,e.yearSelect.disabled=!0),u(e,t,"year",s.exLockYear),e.showMessage(`<strong style="color:#1d4ed8;">EXロック発動！</strong> 導入年=${s.exLockYear}年`)):e.showMessage(`<strong style="color:red;">${s.gained}点</strong>獲得！（残り${s.remaining}）`),s.remaining<=0)){t.isGameOver=!0;const{winnerIndex:l,winnerScore:i}=M(t);e.showMessage(`パンク！ゲーム終了となりプレイヤー${l+1}が${i}点で勝利！`),y(e,t)}v(t,e)}})),e.nextPlayerButton.addEventListener("click",()=>{t.isGameOver||(a.nextPlayer(),e.keywordInput.value="",e.digits.forEach(r=>{r.dataset.value="",r.classList.remove("covered","opened");const n=r.querySelector(".digit-value");n&&(n.textContent="?")}),e.resultMessage.classList.remove("game-over","over-score"),e.resultMessage.textContent="",e.resultList.classList.add("hidden"),e.searchButton.disabled=!1,e.revealButtons.forEach(r=>r.disabled=!1),v(t,e))}),e.restartButton.addEventListener("click",()=>{t.usedWords=new Set,t.scores=[],t.totalPlayers=2,t.currentPlayer=1,t.initialTarget=100,t.remainingPoints=100,t.isGameOver=!1,t.recentHits=[],t.fsm=c.Idle,t.restrict="none","exLockEnabled"in t&&(t.exLockEnabled=!1),"exLocked"in t&&(t.exLocked=!1),"exLockYear"in t&&(t.exLockYear=""),e.playerCount&&(e.playerCount.value="2"),e.targetMode&&(e.targetMode.value="random"),e.targetValue&&(e.targetValue.value="100"),e.randomMin&&(e.randomMin.value="100"),e.randomMax&&(e.randomMax.value="999"),e.targetMode?.dispatchEvent(new Event("change")),e.restrictMode&&(e.restrictMode.value="none",e.restrictMode.disabled=!1),e.yearSelect&&(e.yearSelect.value="",e.yearSelect.disabled=!1),e.andField&&(e.andField.disabled=!1,e.andField.value="none"),e.andValue&&(e.andValue.value=""),e.andYearSelect&&(e.andYearSelect.value=""),e.exLockMode&&(e.exLockMode.value="off"),e.restrictMode?.dispatchEvent(new Event("change")),e.andField?.dispatchEvent(new Event("change")),e.keywordInput&&(e.keywordInput.value=""),e.usedWords&&(e.usedWords.innerHTML=""),e.digits.forEach(r=>{r.dataset.value="",r.classList.remove("covered","opened");const n=r.querySelector(".digit-value");n&&(n.textContent="?")}),e.resultMessage.classList.remove("game-over","over-score"),e.resultMessage.textContent="",e.resultList&&(e.resultList.classList.add("hidden"),e.resultList.innerHTML=""),w(e,[]),e.gameSection.classList.add("hidden"),e.setupSection.classList.remove("hidden"),v(t,e)})}function E(e,t){const a='<option value="">年を選択</option>'+t.map(r=>`<option value="${r}">${r}年</option>`).join("");e.yearSelect&&(e.yearSelect.innerHTML=a),e.andYearSelect&&(e.andYearSelect.innerHTML=a)}function $(e,t,a){const r=()=>{const s=e.targetMode.value==="manual";e.targetValue.classList.toggle("hidden",!s),e.randomRangeBox.style.display=s?"none":"block"};e.targetMode&&(e.targetMode.addEventListener("change",r),r());function n(){const s=e.andField?.value||"none";if(!e.andBox)return;const l=s==="year";e.setHidden(e.andYearSelect,!l),e.setHidden(e.andValue,l||s==="none"),s==="name"&&e.andValue&&(e.andValue.placeholder="機種名を入力"),s==="maker"&&e.andValue&&(e.andValue.placeholder="メーカー名を入力")}e.andField?.addEventListener("change",n);const o=()=>{const s=e.restrictMode?.value==="year";e.setHidden(e.yearBox,!s),e.keywordInput&&(e.keywordInput.placeholder=s?"導入年を選ぶか、4桁の年を入力":"検索ワードを入力");const l=e.restrictMode?.value||"none";e.andField&&(e.andField.value=l==="none"?"none":l,e.andField.disabled=l!=="none"),n()};e.restrictMode&&(e.restrictMode.addEventListener("change",()=>{if(o(),t.scores.length){let s=e.andField?.value||"none";e.restrictMode?.value&&e.restrictMode.value!=="none"&&(s=e.restrictMode.value);let l="";s==="year"?l=e.restrictMode?.value==="year"?e.yearSelect?.value||"":e.andYearSelect?.value||"":(s==="name"||s==="maker")&&(l=e.andValue?.value.trim()||""),u(e,t,s,l)}}),o()),n(),e.startBtn?.addEventListener("click",()=>{a.start({players:parseInt(e.playerCount.value,10),mode:e.targetMode.value,manualValue:e.targetValue.value,randomMin:e.randomMin.value,randomMax:e.randomMax.value,restrict:e.restrictMode?.value??"none",exLockEnabled:e.exLockMode?.value==="on"}),e.keywordInput&&(e.keywordInput.disabled=!1,e.keywordInput.value=""),e.usedWords&&(e.usedWords.innerHTML=""),e.yearSelect?.removeAttribute("disabled"),e.digits.forEach(i=>{i.dataset.value="",i.classList.remove("covered","opened");const d=i.querySelector(".digit-value");d&&(d.textContent="?")}),e.resultMessage.classList.remove("game-over","over-score"),e.resultMessage.textContent="",e.resultList.classList.add("hidden"),e.searchButton.disabled=!1,e.nextPlayerButton.disabled=!1,e.revealButtons.forEach(i=>i.disabled=!1),v(t,e);let s=e.andField?.value||"none";e.restrictMode?.value&&e.restrictMode.value!=="none"&&(s=e.restrictMode.value);let l="";s==="year"?l=e.restrictMode?.value==="year"?e.yearSelect?.value||"":e.andYearSelect?.value||"":(s==="name"||s==="maker")&&(l=e.andValue?.value.trim()||""),u(e,t,s,l)})}function B(){const e=r=>document.querySelector(r),t=r=>Array.from(document.querySelectorAll(r));return{setupSection:e("#setupSection"),gameSection:e("#gameSection"),playerCount:e("#playerCount"),targetMode:e("#targetMode"),targetValue:e("#targetValue"),randomMin:e("#randomMin"),randomMax:e("#randomMax"),startBtn:e("#startBtn"),randomRangeBox:e("#randomRangeBox"),restrictMode:e("#restrictMode"),yearBox:e("#yearBox"),yearSelect:e("#yearSelect"),andBox:e("#andBox"),andField:e("#andField"),andValue:e("#andValue"),andYearSelect:e("#andYearSelect"),exLockMode:e("#exLockMode"),scoreInfo:e("#scoreInfo"),playerScores:e("#playerScores"),keywordInput:e("#keywordInput"),searchButton:e("#searchButton"),digits:[e("#digit1"),e("#digit2"),e("#digit3"),e("#digit4")],revealButtons:t(".reveal-btn"),resultMessage:e("#resultMessage"),nextPlayerButton:e("#nextPlayerButton"),showResultsButton:e("#showResultsButton"),restartButton:e("#restartButton"),resultList:e("#resultList"),usedWords:e("#usedWords"),filterChips:e("#filterChips"),setHidden(r,n){r&&r.classList.toggle("hidden",!!n)},setDisabled(r,n){r.disabled=!!n},setDigitValue(r,n){k(this,r,n)},getDigits(){return I(this)},showMessage(r){this.resultMessage.innerHTML=r},populateYearOptions(r){E(this,r)}}}function H(e,t,a){$(e,t,a),P(e,t,a),b(e,t)}function v(e,t){t.setHidden(t.setupSection,!1),t.setHidden(t.gameSection,!0),e.scores.length&&(t.setHidden(t.setupSection,!0),t.setHidden(t.gameSection,!1)),t.scoreInfo.innerHTML=`残りポイント: <span class="score-value">${e.remainingPoints}</span> / <span class="highlight-target">${e.initialTarget}</span>`,t.playerScores.innerHTML="",e.scores.forEach((a,r)=>{const n=document.createElement("div");r+1===e.currentPlayer&&!e.isGameOver&&(n.style.fontWeight="bold",n.style.color="blue"),n.innerHTML=`P${r+1}: <span class="player-score-value">${a}</span>点`,t.playerScores.appendChild(n)})}function C(){return{csvData:[],years:[],usedWords:new Set,scores:[],totalPlayers:2,currentPlayer:1,initialTarget:100,remainingPoints:100,isGameOver:!1,recentHits:[],fsm:"Idle",restrict:"none",exLockEnabled:!1,exLocked:!1,exLockYear:""}}class Y{constructor(t,a){this.state=t,this.ui=a,this.worker=null,this.pendingSearches=new Map}setWorker(t){this.worker=t,this.worker.addEventListener("message",a=>{const{type:r,digits:n,recentHits:o,id:s,error:l}=a.data;if(r==="search-result"){const i=this.pendingSearches.get(s);i&&(this.state.recentHits=o,this.state.fsm=c.Searching,this.state.lastKeyword&&this.state.usedWords.add(this.state.lastKeyword),i(n),this.pendingSearches.delete(s))}else r==="error"&&console.error("Worker error:",l)})}start({players:t,mode:a,manualValue:r,randomMin:n,randomMax:o,restrict:s="none",exLockEnabled:l=!1}){if(!h("start",this.state))return;const i=this.state;if(i.totalPlayers=Math.max(1,Math.min(8,Number(t)||1)),i.restrict=s,i.exLockEnabled=!!l,i.exLocked=!1,i.exLockYear="",a==="manual"){const d=Number(r??100);i.initialTarget=Math.max(100,Math.min(8192,d))}else{let d=Math.max(Number(n??100),1),f=Math.min(Number(o??1280),8192);d>f&&([d,f]=[f,d]),i.initialTarget=Math.floor(Math.random()*(f-d+1))+d}i.remainingPoints=i.initialTarget,i.scores=Array(i.totalPlayers).fill(0),i.currentPlayer=1,i.usedWords=new Set,i.isGameOver=!1,i.recentHits=[],i.fsm=c.Idle}async search(t,a={field:"none",value:""}){return h("search",this.state)?(this.state.lastKeyword=t,new Promise(r=>{const n=Math.random().toString(36).substr(2,9);this.pendingSearches.set(n,r),this.worker.postMessage({type:"search",payload:{keyword:t,andCond:a},id:n})})):null}revealIfAllOpened(){if(!h("reveal",this.state))return null;const t=this.state,a=this.ui.getDigits();if(a.some(s=>s==="?"))return null;const r=parseInt(a.join(""),10),n=t.currentPlayer-1;if(r===t.remainingPoints)return t.scores[n]+=8192,t.isGameOver=!0,t.fsm=c.GameOver,{type:"perfect",gained:r};if(r>t.remainingPoints)return t.scores[n]=0,t.isGameOver=!0,t.fsm=c.GameOver,{type:"bust",gained:r};t.scores[n]+=r,t.remainingPoints-=r;let o=null;if(t.exLockEnabled&&!t.exLocked&&t.remainingPoints>0&&t.remainingPoints<=9){const s=t.years||[];s.length&&(o=s[Math.floor(Math.random()*s.length)],t.exLocked=!0,t.exLockYear=o,t.restrict="year")}return t.fsm=c.Revealing,{type:"score",gained:r,remaining:t.remainingPoints,exLockYear:o}}nextPlayer(){if(!h("next",this.state))return;const t=this.state;t.currentPlayer=t.currentPlayer%t.totalPlayers+1,t.fsm=c.Idle}}const p=C(),g=B(),L=new Y(p,g);(async function(){try{const t=new Worker(new URL("/assets/search.worker-AYy-jxZ8.js",import.meta.url),{type:"module"});L.setWorker(t),t.addEventListener("message",n=>{const{type:o,years:s,error:l}=n.data;o==="init-complete"?(p.years=s,typeof g.populateYearOptions=="function"&&g.populateYearOptions(s),v(p,g),H(g,p,L)):o==="error"&&(g.resultMessage.textContent="初期化エラー: "+l)});const r="/machinelist.csv".replace("//","/");t.postMessage({type:"init",payload:{path:r}})}catch(t){console.error(t),g.resultMessage.textContent="起動エラーが発生しました。"}})();
